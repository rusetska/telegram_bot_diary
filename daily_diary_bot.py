# -*- coding: utf-8 -*-
"""daily_diary_bot.ipynb

Automatically generated by Colab.

Original file is located at
    https://colab.research.google.com/drive/1LX_bQZA_8pi9Ivhn7ib8YNFxy1nvZIxU

–õ–µ–Ω—å ‚Äî –ª—É—á—à–∏–π –¥–≤–∏–≥–∞—Ç–µ–ª—å –ø—Ä–æ–≥—Ä–µ—Å—Å–∞.

–ú–Ω–µ –Ω–∞—Å–∫—É—á–∏–ª–æ –≤—Ä—É—á–Ω—É—é –ø–ª–∞–Ω–∏—Ä–æ–≤–∞—Ç—å –æ–¥–Ω–æ—Ç–∏–ø–Ω—ã–µ –ø–æ—Å—Ç—ã –≤ –ª–∏—á–Ω—ã–π –∫–∞–Ω–∞–ª-–¥–Ω–µ–≤–Ω–∏–∫, —Ç–∞–∫ —á—Ç–æ –∞–≤—Ç–æ–º–∞—Ç–∏–∑–∏—Ä—É–µ–º –ø—Ä–æ—Ü–µ—Å—Å: Google Sheets, Python –∏ –º–æ—è –ª—é–±–∏–º–∞—è –ø–æ–º–æ—â–Ω–∏—Ü–∞ ‚Äî –¥–∞-–¥–∞, —É –º–µ–Ω—è ChatGPT ‚Äî –¥–µ–≤–æ—á–∫–∞ üòä
"""

#—É–∫–∞–∑—ã–≤–∞–µ–º –≥–æ–¥ –∏ –≤—Ä–µ–º—è –ø—É–±–ª–∏–∫–∞—Ü–∏–∏
YEAR = 2025
FIVEBOOK_HOUR = 9
REFLECTION_HOUR = 18

#–∏–º–ø–æ—Ä—Ç–∏—Ä—É–µ–º –±–∏–±–ª–∏–æ—Ç–µ–∫–∏
import pandas as pd
import re
import asyncio
import os
from datetime import datetime, timedelta
from telegram import Bot
from telegram.ext import Application, JobQueue

#–ø–æ–¥–∫–ª—é—á–∞–µ–º —Ç–æ–∫–µ–Ω –∏ id –∫–∞–Ω–∞–ª–∞
TOKEN = os.getenv("TELEGRAM_BOT_TOKEN")
CHAT_ID = os.getenv("TELEGRAM_CHAT_ID")
if not TOKEN:
    raise ValueError("‚õîÔ∏è –¢–æ–∫–µ–Ω –Ω–µ –Ω–∞–π–¥–µ–Ω! –ü—Ä–æ–≤–µ—Ä—å, –¥–æ–±–∞–≤–ª–µ–Ω –ª–∏ –æ–Ω –≤ —Å–µ–∫—Ä–µ—Ç—ã.")
else:
    print("‚úÖ –¢–æ–∫–µ–Ω —É—Å–ø–µ—à–Ω–æ –∑–∞–≥—Ä—É–∂–µ–Ω!")

#–ø–æ–¥–≥—Ä—É–∂–∞–µ–º –æ–±–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã —Å –≤–æ–ø—Ä–æ—Å–∞–º–∏
fivebook, reflection = (pd.read_csv("https://docs.google.com/spreadsheets/d/1bg-5nIYub5Ydo2S6tR9eQgGwKSAszzh9WPF6EEBt6nY/gviz/tq?tqx=out:csv&gid=301691926"),
                        pd.read_csv("https://docs.google.com/spreadsheets/d/1bg-5nIYub5Ydo2S6tR9eQgGwKSAszzh9WPF6EEBt6nY/gviz/tq?tqx=out:csv&gid=315900274"))
#–º–µ–Ω—è–µ–º —Ñ–æ—Ä–º–∞—Ç –¥–∞—Ç—ã
fivebook["date"] = pd.to_datetime(fivebook["date"], format="%d.%m.%Y")
reflection["date"] = pd.to_datetime(reflection["date"], format="%d.%m.%Y")
#–ø–æ–¥—Ç—è–≥–∏–≤–∞–µ–º –≥–æ–¥ –∏ –≤—Ä–µ–º—è –ø—É–±–ª–∏–∫–∞—Ü–∏–∏
fivebook["date"] = fivebook["date"].apply(lambda x: x.replace(year=YEAR, hour=FIVEBOOK_HOUR))
reflection["date"] = reflection["date"].apply(lambda x: x.replace(year=YEAR, hour=REFLECTION_HOUR))

#—Ñ—É–Ω–∫—Ü–∏—è –¥–ª—è —ç–∫—Ä–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏—è —Å–ø–µ—Ü—Å–∏–º–≤–æ–ª–æ–≤, —á—Ç–æ–±—ã –≤ –ø–æ—Å—Ç–µ –º–æ–∂–Ω–æ –±—ã–ª–æ –≤—ã–¥–µ–ª—è—Ç—å —Ç–µ–∫—Å—Ç
def escape_markdown(text):
    escape_chars = r'_*\[\]()~>#+-=|{}.!'
    return re.sub(f"([{re.escape(escape_chars)}])", r"\\\1", text)

#–∞—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è –æ—Ç–ø—Ä–∞–≤–∫–∏ —Å–æ–æ–±—â–µ–Ω–∏–π
async def send_scheduled_messages(days):
    #—Å–æ–∑–¥–∞—ë–º –±–æ—Ç–∞ –¥–ª—è –æ—Ç–ø—Ä–∞–≤–∫–∏ —Å–æ–æ–±—â–µ–Ω–∏–π
    bot = Bot(token=TOKEN)
    #–≤—ã–±–∏—Ä–∞–µ–º –ø–æ—Å—Ç—ã –∏–∑ –æ–±–µ–∏—Ö —Ç–∞–±–ª–∏—Ü –¥–ª—è –ø—É–±–ª–∏–∫–∞—Ü–∏–∏ –≤ —É–∫–∞–∑–∞–Ω–Ω–æ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –¥–Ω–µ–π –æ—Ç —Ç–µ–∫—É—â–µ–≥–æ
    fivebook_posts = fivebook[(fivebook["date"] >= datetime.now()) & (fivebook["date"] < datetime.now() + timedelta(days=days))]
    reflection_posts = reflection[(reflection["date"] >= datetime.now()) & (reflection["date"] < datetime.now() + timedelta(days=days))]
    #–∑–∞–ø—É—Å–∫–∞–µ–º —Ü–∏–∫–ª –¥–ª—è –ø—É–±–ª–∏–∫–∞—Ü–∏–∏ –ø–æ—Å—Ç–æ–≤
    for _, row in fivebook_posts.iterrows():
        post_time = row["date"]
        delay = (post_time - datetime.now()).total_seconds()
        #–∂–¥—ë–º –Ω—É–∂–Ω–æ–µ –≤—Ä–µ–º—è –ø–µ—Ä–µ–¥ –ø—É–±–ª–∏–∫–∞—Ü–∏–µ–π
        if delay > 0:
            print(f"–ñ–¥—ë–º {delay:.2f} —Å–µ–∫—É–Ω–¥ –¥–æ –ø—É–±–ª–∏–∫–∞—Ü–∏–∏ –ø–æ—Å—Ç–∞.")
            await asyncio.sleep(delay)
            message = f"{escape_markdown(row['hashtag'])}\n\n*{escape_markdown(row['question'])}*"
            await bot.send_message(chat_id=CHAT_ID, text=message, parse_mode="MarkdownV2")
            print("‚úÖ –í–æ–ø—Ä–æ—Å –ø—è—Ç–∏–±—É–∫–∞ –æ–ø—É–±–ª–∏–∫–æ–≤–∞–Ω!")
            #–≤–∫–ª–∞–¥—ã–≤–∞–µ–º —Ü–∏–∫–ª –¥–ª—è –ø—É–±–ª–∏–∫–∞—Ü–∏–∏ –≤—Ç–æ—Ä–æ–≥–æ –ø–æ—Å—Ç–∞
            for _, row in reflection_posts.iterrows():
              post_time = row["date"]
              delay = (post_time - datetime.now()).total_seconds()
              #–∂–¥—ë–º –Ω—É–∂–Ω–æ–µ –≤—Ä–µ–º—è –ø–µ—Ä–µ–¥ –ø—É–±–ª–∏–∫–∞—Ü–∏–µ–π
              if delay > 0:
                print(f"–ñ–¥—ë–º {delay:.2f} —Å–µ–∫—É–Ω–¥ –¥–æ –ø—É–±–ª–∏–∫–∞—Ü–∏–∏ –ø–æ—Å—Ç–∞.")
                await asyncio.sleep(delay)
                message = f"{escape_markdown(row['hashtag'])}\n\n*{escape_markdown(row['question'])}*"
                await bot.send_message(chat_id=CHAT_ID, text=message, parse_mode="MarkdownV2")
                print("‚úÖ –ü–æ—Å—Ç –¥–ª—è —Å–∞–º–æ–∞–Ω–∞–ª–∏–∑–∞ –æ–ø—É–±–ª–∏–∫–æ–≤–∞–Ω!")
#–ø—É–±–ª–∏–∫–∞—Ü–∏—è –æ—Ç–ª–æ–∂–µ–Ω–Ω—ã—Ö –ø–æ—Å—Ç–æ–≤
task = asyncio.create_task(send_scheduled_messages(2))
await task